<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        table, tr, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 5px 10px;
        }

        input[type="number"] {
            width: 50px;
        }
    </style>
    <script>
        const clearTable = () => {
            const table1 = document.querySelector('#first-results tbody');
            const table2 = document.querySelector('#second-results tbody');

            table1.innerHTML = '';
            table2.innerHTML = '';
        }

        const appendResult = (tableId, numOfRequests, time) => {
            const table = document.querySelector(`#${tableId} tbody`);
            const newRow = table.insertRow();
            newRow.insertCell();
            const cell1 = newRow.insertCell();
            const cell2 = newRow.insertCell();

            cell1.appendChild(document.createTextNode(numOfRequests))
            cell2.appendChild(document.createTextNode(time))
        }

        const makeRequest = async (data) => {
            return fetch('/start', {
                method: 'post',
                body: data
            }).then(async (res) => {
                const data = await res.json();
                if (!res.ok) {
                    throw data;
                }

                return data;
            });
        }

        const randomInRange = (min, max) => {
            min = Math.ceil(min); // Round up the minimum value
            max = Math.floor(max); // Round down the maximum value
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        const handleClick = async () => {
            clearTable();
            const data = new FormData();
            const file = document.querySelector('input[name="file"]').files[0];
            data.set("file", file)

            const repetition = parseInt(document.querySelector('input[name="repetition"]').value);
            const interval = parseFloat(document.querySelector('input[name="interval"]').value);
            const threshold = parseInt(document.querySelector('input[name="threshold"]').value);

            const minRequests = parseInt(document.querySelector('input[name="minReq"]').value);

            const generatedArray = Array.from({ length: repetition }).map(() => randomInRange(minRequests, threshold));
            document.querySelector('#generated-array').innerHTML = "Number of requests send by repetition: " + generatedArray.join(' ');

            const start = new Date();
            let rep = 0;

            (function foo() {
                if (rep >= repetition * 2){
                    return;
                }

                const tableToAppend = rep < repetition ? "first-results" : "second-results";
                if (rep >= repetition) {
                    data.set("toCloudRun", "true");
                }

                data.set("numOfRequests", generatedArray[rep % repetition]);

                makeRequest(data)
                    .then(res => appendResult(tableToAppend, res.numOfRequests, res.time))
                    .catch(err => {
                        appendResult(tableToAppend, res.numOfRequests, "FAILED")
                        console.log("Error: ", err)}
                    )

                rep++;
                setTimeout(foo, interval * 1000);
            })();
        }
    </script>
</head>

<body>
    <!-- <form action="/start" method="post" enctype="multipart/form-data"> -->
        <label>
            File:
            <br />
            <input type="file" name="file" />
        </label>
        <br />
        <br />

        For <input type="number" name="repetition"/> repetitions, with a pause of <input type="number" name="interval"/> seconds inbetween
        dispatch random number of requests ranging from <input type="number" value="1" name="minReq"/> to <input type="number" name="threshold" />

        <br />
        <br />

        <p id="generated-array">
        </p>

        <button type="button" onclick="handleClick()">Start</button>
        <br/>
        <br/>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); column-gap: 50px;">
            <table id="first-results">
                <thead>
                    <tr>
                        <th>Results</th>
                        <th>Number of requests</th>
                        <th>Time in milliseconds</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <table id="second-results">
                <thead>
                    <tr>
                        <th>Results</th>
                        <th>Number of requests</th>
                        <th>Time in milliseconds</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <!-- <button type="submit">Start</button> -->
    <!-- </form> -->

</body>

</html>